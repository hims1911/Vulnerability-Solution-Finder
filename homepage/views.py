from django.shortcuts import render
from django.http import HttpResponse,JsonResponse,HttpResponseNotFound
from django.template import loader
import subprocess
import os
import json

# Create your views here.
def index(request):
    template = loader.get_template('homepage.html')

    context = {
        'collectData' : 'By Ranjeet & Himanshu',
    }
    return HttpResponse(template.render(context, request))

def vulnFunction(request):
    if (request.method =='POST'):
        print(request.POST)
        data = request.POST['codeSnippet']
        template = loader.get_template('vuln_solution.html')
        context = {
            'flag': 'True',
            'data': data,
            'codeType' : request.POST['codeType'],
        }
        data = data.replace('\r','')

        '''creating the file to copy the text area'''
        new_file = "input_text.txt"
        file = open(new_file,"w")
        file.write(data)
        file.close()

        command = "python solprovider.py " + new_file + " " + request.POST['codeType']
        result = command
        print(result)
        os.system(command)

        file = open(new_file, "r")
        solution = file.read()
        print(solution)
        file.close()
        #del_command = "del /f " + new_file
        #os.system(del_command)

        vuln_exist = True
        with open('vuln_data', 'r') as json_file:
            result = json.load(json_file)
            if len(result):
                vuln_exist = True

        context.update({'result':result})
        context.update({'vulnerability_present': vuln_exist})
        context.update({'solution': solution})
        print("----------------------------")
        print(context)
        print(len(context['result']))
        file.close()

        return render(request, 'homepage.html', context)

